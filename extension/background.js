const Q={debug:0,info:1,warn:2,error:3};let we="info";function ye(e){return Q[e]>=Q[we]}function ke(e){const t=new Date().toISOString(),n=`[${e.component}]`;let r=`${t} ${e.level.toUpperCase()} ${n} ${e.message}`;return e.data&&(r+=` ${JSON.stringify(e.data)}`),r}function D(e){if(!ye(e.level))return;const t=ke(e);switch(e.level){case"debug":console.debug(t);break;case"info":console.log(t);break;case"warn":console.warn(t);break;case"error":console.error(t,e.error||"");break}}function R(e){return{debug:(t,n)=>D({level:"debug",component:e,message:t,data:n}),info:(t,n)=>D({level:"info",component:e,message:t,data:n}),warn:(t,n)=>D({level:"warn",component:e,message:t,data:n}),error:(t,n,r)=>D({level:"error",component:e,message:t,data:r,error:n})}}const X=R("Storage"),I={sync:{backendUrl:""},local:{authToken:""}};let C={sync:{},local:{}};const F=new Set;async function qe(){const[e,t]=await Promise.all([chrome.storage.sync.get(Object.keys(I.sync)),chrome.storage.local.get(Object.keys(I.local))]);C.sync={...I.sync,...e},C.local={...I.local,...t},X.debug("Storage initialized",{sync:C.sync,local:"***"}),chrome.storage.onChanged.addListener((n,r)=>{const o=r;for(const[i,c]of Object.entries(n)){o==="sync"&&i in I.sync?C.sync[i]=c.newValue:o==="local"&&i in I.local&&(C.local[i]=c.newValue);for(const s of F)try{s({key:i,oldValue:c.oldValue,newValue:c.newValue})}catch(a){X.error("Storage change listener error",a instanceof Error?a:void 0)}}})}function Se(e){return F.add(e),()=>F.delete(e)}const N=R("ConnectionState"),Ie={connection:{status:"disconnected",url:null,lastConnectedAt:null,lastError:null,reconnectAttempts:0},queue:{length:0,droppedCount:0,oldestTimestamp:null},session:{token:null,expiresAt:null}};let f={...Ie};const Ee=new Set;function U(){return f}function x(){for(const e of Ee)try{e(f)}catch(t){N.error("State listener error",t instanceof Error?t:void 0)}}function Ce(e){N.info("Connecting",{url:e}),f={...f,connection:{...f.connection,status:"connecting",url:e,lastError:null}},x()}function Te(){N.info("Connected"),f={...f,connection:{...f.connection,status:"connected",lastConnectedAt:Date.now(),lastError:null,reconnectAttempts:0}},x()}function te(e){N.info("Disconnected",{error:e}),f={...f,connection:{...f.connection,status:"disconnected",lastError:e??null}},x()}function ve(e){N.info("Reconnecting",{attempt:e}),f={...f,connection:{...f.connection,status:"reconnecting",reconnectAttempts:e}},x()}function ne(e){f={...f,queue:e},x()}function re(e){return f.connection.status!=="connected"&&f.connection.reconnectAttempts<e}const oe=R("State");let d=null;const O=new Set,h=[],Le=10,Re=300*1e3;function Ne(e){const t=Date.now();let n=0;for(;h.length>0&&t-(h[0]?.timestamp??0)>Re;)h.shift(),n++;for(h.push({element:e,timestamp:t});h.length>Le;)h.shift(),n++;ne({length:h.length,droppedCount:n,oldestTimestamp:h[0]?.timestamp??null}),oe.info("Queued element selection",{pending:h.length,dropped:n})}function xe(){const e=[...h];return h.length=0,ne({length:0,droppedCount:0,oldestTimestamp:null}),e}function B(e){d=e}function M(e){O.forEach(t=>{try{t.postMessage(e)}catch(n){oe.error("Failed to send message to client",n instanceof Error?n:void 0),O.delete(t)}})}const se={maxAttempts:10};function Ae(e){let t=e.trim();if(!t)return"";t.match(/^https?:\/\//)||(t=`https://${t}`),t=t.replace(/\/+$/,"");try{new URL(t)}catch{throw new Error(`Invalid URL format: ${e}`)}return t}async function De(){const[e,t]=await Promise.all([chrome.storage.sync.get(["backendUrl"]),chrome.storage.local.get(["authToken"])]),n=Ae(e.backendUrl||"");if(!n)throw new Error("No backend URL configured. Paste a connection code in the extension popup.");const r=new URL(n),i=`${r.protocol==="https:"?"wss:":"ws:"}//${r.host}`;return{apiUrl:n,wsUrl:i,authToken:t.authToken||""}}let W=null,E=null;async function We(){return W||(E||(E=De().then(e=>(W=e,E=null,e)).catch(e=>{throw E=null,e})),E)}async function Ue(){return We()}function Oe(e,t){const n=t.startsWith("/")?t:`/${t}`;return`${e.replace(/\/+$/,"")}${n}`}function Y(){W=null,E=null}function Me(){chrome.storage.onChanged.addListener((e,t)=>{t==="sync"&&e.backendUrl&&Y(),t==="local"&&e.authToken&&Y()})}async function G(e,t,n){const r=await chrome.scripting.executeScript({target:{tabId:e},func:t,args:n});if(r&&r[0])return r[0].result;throw new Error("Script execution returned no result")}function _e(e,t,n){const r=document.querySelector(e);if(!r)return null;const o=r.getBoundingClientRect(),i=r,c={};for(const P of r.attributes)c[P.name]=P.value;const s=window.getComputedStyle(r),a=s.display!=="none"&&s.visibility!=="hidden"&&s.opacity!=="0"&&o.width>0&&o.height>0;let p;if(t){const pe=n||["display","position","width","height","margin","padding","color","backgroundColor","fontSize","fontFamily","fontWeight","border","borderRadius","boxShadow","opacity","zIndex","flexDirection","justifyContent","alignItems","gap"];p={};for(const H of pe)p[H]=s.getPropertyValue(H)||s[H]||""}const S=5e3;let m=i.innerHTML,w=i.outerHTML;m.length>S&&(m=m.substring(0,S)+"... [truncated]"),w.length>S&&(w=w.substring(0,S)+"... [truncated]");let A=i.innerText||"";return A.length>1e3&&(A=A.substring(0,1e3)+"... [truncated]"),{tagName:r.tagName.toLowerCase(),id:r.id||void 0,className:r.className||void 0,attributes:c,innerText:A,innerHTML:m,outerHTML:w,bounds:{x:o.x,y:o.y,width:o.width,height:o.height,top:o.top,right:o.right,bottom:o.bottom,left:o.left},computedStyles:p,isVisible:a,childCount:r.children.length}}function $e(e){const t=document.querySelector(e);if(!t)return{success:!1,error:`Element not found: ${e}`};const n=t.getBoundingClientRect(),r=window.getComputedStyle(t);return r.display==="none"||r.visibility==="hidden"?{success:!1,error:"Element is not visible"}:n.width===0||n.height===0?{success:!1,error:"Element has no dimensions"}:(t.scrollIntoView({behavior:"instant",block:"center"}),t.click(),{success:!0})}function Pe(e,t){const n=document.querySelector(e);if(!n)return{success:!1,error:`Element not found: ${e}`};const r=n.tagName.toLowerCase();return r!=="input"&&r!=="textarea"&&!n.isContentEditable?{success:!1,error:`Element is not fillable: ${r}`}:(n.focus(),n.isContentEditable?n.textContent=t:n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),{success:!0})}async function j(e){if(e!==void 0)return e;const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t?.id)throw new Error("No active tab found");return t.id}async function He(e){try{const t=await j(e.tabId),n=await G(t,_e,[e.selector,e.includeStyles??!0,e.styleProperties]);if(!n){u({type:"browser-get-element-info-result",requestId:e.requestId,success:!1,error:`Element not found: ${e.selector}`});return}u({type:"browser-get-element-info-result",requestId:e.requestId,success:!0,element:n})}catch(t){u({type:"browser-get-element-info-result",requestId:e.requestId,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Be(e){try{const t=await j(e.tabId),n=await G(t,$e,[e.selector]);u({type:"browser-click-element-result",requestId:e.requestId,success:n.success,error:n.error})}catch(t){u({type:"browser-click-element-result",requestId:e.requestId,success:!1,error:t instanceof Error?t.message:String(t)})}}async function Fe(e){try{const t=await j(e.tabId),n=await G(t,Pe,[e.selector,e.value]);u({type:"browser-fill-input-result",requestId:e.requestId,success:n.success,error:n.error})}catch(t){u({type:"browser-fill-input-result",requestId:e.requestId,success:!1,error:t instanceof Error?t.message:String(t)})}}const g=new Map;let b={enabled:!1,maxRequests:1e3,redactHeaders:["authorization","cookie","set-cookie","x-auth-token"]};const ze=1800*1e3,ce=300*1e3;let K=0,_=!1;function ae(e){if(e)return e.map(t=>{const n=t.name.toLowerCase();return b.redactHeaders.some(r=>n===r.toLowerCase())?{name:t.name,value:"[REDACTED]"}:{name:t.name,value:t.value}})}function J(e){if(!(typeof e!="number"||!Number.isInteger(e)||e<0))return e}function Ve(e){return!b.urlFilter||b.urlFilter.length===0?!0:b.urlFilter.some(t=>{try{return new RegExp(t,"i").test(e)}catch{return!1}})}function ie(e){if(g.size===0)return;const t=e-ze;for(const[n,r]of g)r.startTime<t&&g.delete(n)}function ue(){const e=Date.now();e-K<ce||(K=e,ie(e))}function le(e){if(b.enabled&&!(b.tabId!==void 0&&e.tabId!==b.tabId)&&Ve(e.url)){if(ue(),g.size>=b.maxRequests){const t=g.keys().next().value;t&&g.delete(t)}g.set(e.requestId,{requestId:e.requestId,url:e.url,method:e.method,type:e.type,tabId:e.tabId,startTime:e.timeStamp})}}function de(e){if(!b.enabled)return;const t=g.get(e.requestId);t&&(t.requestHeaders=ae(e.requestHeaders))}function fe(e){if(!b.enabled)return;const t=g.get(e.requestId);t&&(t.responseHeaders=ae(e.responseHeaders),t.statusCode=e.statusCode,t.statusLine=e.statusLine)}function be(e){if(!b.enabled)return;const t=g.get(e.requestId);t&&(t.fromCache=e.fromCache,t.endTime=e.timeStamp,t.durationMs=e.timeStamp-t.startTime)}function ge(e){if(!b.enabled)return;const t=g.get(e.requestId);t&&(t.error=e.error,t.endTime=e.timeStamp,t.durationMs=e.timeStamp-t.startTime)}function Ge(){if(_)return;const e={urls:["<all_urls>"]};chrome.webRequest.onBeforeRequest.addListener(le,e),chrome.webRequest.onSendHeaders.addListener(de,e,["requestHeaders"]),chrome.webRequest.onHeadersReceived.addListener(fe,e,["responseHeaders"]),chrome.webRequest.onCompleted.addListener(be,e),chrome.webRequest.onErrorOccurred.addListener(ge,e),_=!0,console.log("[Network] Listeners registered")}function je(){_&&(chrome.webRequest.onBeforeRequest.removeListener(le),chrome.webRequest.onSendHeaders.removeListener(de),chrome.webRequest.onHeadersReceived.removeListener(fe),chrome.webRequest.onCompleted.removeListener(be),chrome.webRequest.onErrorOccurred.removeListener(ge),_=!1,console.log("[Network] Listeners unregistered"))}function Je(e){b={enabled:!0,tabId:J(e.tabId),urlFilter:e.urlFilter,maxRequests:e.maxRequests||1e3,redactHeaders:e.redactHeaders||["authorization","cookie","set-cookie","x-auth-token"]},Ge(),u({type:"browser-enable-network-capture-result",requestId:e.requestId,success:!0,config:{tabId:b.tabId,maxRequests:b.maxRequests,redactHeaders:b.redactHeaders}})}function Qe(e){b.enabled=!1,je(),u({type:"browser-disable-network-capture-result",requestId:e.requestId,success:!0})}function Xe(e){ue();let t=Array.from(g.values());const n=J(e.tabId);if(n!==void 0&&(t=t.filter(s=>s.tabId===n)),e.type&&(t=t.filter(s=>s.type===e.type)),e.urlPattern)try{const s=new RegExp(e.urlPattern,"i");t=t.filter(a=>s.test(a.url))}catch{}t.sort((s,a)=>a.startTime-s.startTime);const r=e.offset||0,o=e.limit||100,i=t.length,c=t.slice(r,r+o);u({type:"browser-get-network-requests-result",requestId:e.requestId,success:!0,total:i,offset:r,limit:o,requests:c})}setInterval(()=>{ie(Date.now())},ce);function Ye(e){const t=J(e.tabId);if(t!==void 0)for(const[n,r]of g)r.tabId===t&&g.delete(n);else g.clear();u({type:"browser-clear-network-requests-result",requestId:e.requestId,success:!0,remaining:g.size})}const y=new Map,Ke=1024*1024;function Ze(e,t,n){const r=n,o=e.tabId;if(!o)return;const i=y.get(o);if(i)switch(t){case"Network.requestWillBeSent":{const c=r?.requestId,s=r?.request;if(i.requests.size>=i.maxRequests){const a=i.requests.keys().next().value;a&&i.requests.delete(a)}i.requests.set(c,{requestId:c,url:s?.url,method:s?.method,resourceType:r?.type,tabId:o,timestamp:Date.now(),requestHeaders:s?.headers});break}case"Network.responseReceived":{const c=r?.requestId,s=r?.response,a=i.requests.get(c);a&&(a.statusCode=s?.status,a.mimeType=s?.mimeType,a.responseHeaders=s?.headers,a.encodedDataLength=s?.encodedDataLength);break}case"Network.loadingFinished":{const c=r?.requestId,s=i.requests.get(c);s&&o&&et(o,c,s);break}case"Network.loadingFailed":{const c=r?.requestId,s=i.requests.get(c);s&&(s.error=r?.errorText);break}}}async function et(e,t,n){try{const r=await chrome.debugger.sendCommand({tabId:e},"Network.getResponseBody",{requestId:t});r?.body&&(r.body.length<=Ke?n.responseBody=r.base64Encoded?`[base64] ${r.body.slice(0,1e3)}...`:r.body:n.responseBody=`[truncated: ${r.body.length} bytes]`)}catch{}}function tt(e,t){const n=e.tabId;if(n){const r=y.get(n);r&&(r.attached=!1)}}let Z=!1;function nt(){Z||(chrome.debugger.onEvent.addListener(Ze),chrome.debugger.onDetach.addListener(tt),Z=!0)}async function rt(e){const{requestId:t,tabId:n,maxRequests:r=100}=e;try{if(nt(),y.get(n)?.attached){u({type:"browser-enable-debugger-capture-result",requestId:t,success:!0,message:"Debugger already attached"});return}await chrome.debugger.attach({tabId:n},"1.3"),await chrome.debugger.sendCommand({tabId:n},"Network.enable",{}),y.set(n,{tabId:n,attached:!0,requests:new Map,maxRequests:r}),u({type:"browser-enable-debugger-capture-result",requestId:t,success:!0,tabId:n})}catch(o){u({type:"browser-enable-debugger-capture-result",requestId:t,success:!1,error:o instanceof Error?o.message:String(o)})}}async function ot(e){const{requestId:t,tabId:n}=e;try{y.get(n)?.attached&&await chrome.debugger.detach({tabId:n}),y.delete(n),u({type:"browser-disable-debugger-capture-result",requestId:t,success:!0})}catch(r){u({type:"browser-disable-debugger-capture-result",requestId:t,success:!1,error:r instanceof Error?r.message:String(r)})}}function st(e){const{requestId:t,tabId:n,urlPattern:r,resourceType:o,limit:i=50,offset:c=0}=e,s=y.get(n);if(!s){u({type:"browser-get-debugger-requests-result",requestId:t,success:!1,error:"No debugger session for this tab"});return}let a=Array.from(s.requests.values());if(r)try{const m=new RegExp(r,"i");a=a.filter(w=>m.test(w.url))}catch{}o&&(a=a.filter(m=>m.resourceType===o)),a.sort((m,w)=>w.timestamp-m.timestamp);const p=a.length,S=a.slice(c,c+i);u({type:"browser-get-debugger-requests-result",requestId:t,success:!0,requests:S,total:p,limit:i,offset:c})}function ct(e){const{requestId:t,tabId:n}=e,r=y.get(n);r&&r.requests.clear(),u({type:"browser-clear-debugger-requests-result",requestId:t,success:!0})}const l=R("WebSocket"),$="ws-reconnect";function at(e){return typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"}let z=null,T=null;const it=3e4;let v=null,L=!1;function V(){return d?.readyState===WebSocket.OPEN}function ee(e){e?(chrome.action.setBadgeText({text:""}),chrome.action.setBadgeBackgroundColor({color:"#069F00"})):(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#E90007"}))}function ut(){return U().connection.reconnectAttempts}function lt(e){z=e}function dt(){v===null&&(v=setInterval(()=>{d?.readyState===WebSocket.OPEN&&d.send(JSON.stringify({type:"ping",ts:Date.now()}))},it))}function he(){v!==null&&(clearInterval(v),v=null)}function u(e){L||(d?.readyState===WebSocket.OPEN?d.send(JSON.stringify(e)):(l.error("WebSocket not connected",void 0,{state:d?.readyState}),(!d||d.readyState===WebSocket.CLOSED)&&(l.info("Attempting to reconnect WebSocket"),k())))}async function k(){if(T)return T;if(L=!1,d?.readyState===WebSocket.OPEN){l.debug("WebSocket already connected");return}if(d?.readyState===WebSocket.CONNECTING){l.debug("WebSocket already connecting");return}if(d){try{d.close()}catch{}B(null)}const e=(async()=>{const t=await Ue(),n=t.wsUrl;let r=null;try{const c=Oe(t.apiUrl,"/api/auth/token"),s={};t.authToken&&(s["X-Auth-Token"]=t.authToken);const a=await fetch(c,{headers:s});if(a.ok){const p=await a.json();p.token&&(r=p.token,l.debug("Got auth token from backend"))}}catch(c){l.warn("Failed to fetch token from backend",{error:c instanceof Error?c.message:String(c)})}!r&&t.authToken&&(r=t.authToken,l.debug("Using configured auth token")),Ce(n),l.info("Connecting to WebSocket",{url:n});const o=new WebSocket(n);B(o),o.onopen=()=>{if(d!==o){try{o.close()}catch{}return}if(l.info("WebSocket connected, authenticating"),r)o.send(JSON.stringify({type:"auth",token:r}));else if(n.includes("localhost")||n.includes("127.0.0.1"))i(o);else{l.error("No auth token available for remote connection"),o.close(4001,"No auth token");return}},o.onmessage=c=>{if(d===o)try{const s=JSON.parse(c.data);if(!at(s)){l.warn("Invalid message format",{data:typeof c.data});return}if(s.type==="auth-success"){i(o);return}ft(s).catch(a=>{l.error("Message handler failed",a instanceof Error?a:void 0,{type:s.type})})}catch(s){l.error("Failed to parse WebSocket message",s instanceof Error?s:void 0)}};function i(c){l.info("WebSocket authenticated"),Te(),chrome.alarms.clear($),dt(),c.send(JSON.stringify({type:"identify",clientType:"extension"})),M({type:"WS_CONNECTED"});const s=xe();if(s.length>0){l.info("Flushing queued element selections",{count:s.length});for(const a of s)u({type:"element-selected",element:a.element})}ee(!0)}o.onerror=c=>{d===o&&l.error("WebSocket error",void 0,{error:String(c)})},o.onclose=c=>{if(d!==o)return;const a={1e3:"Normal closure",1001:"Going away",1006:"Abnormal closure (connection lost)",4001:"Unauthorized"}[c.code]||"Unknown";l.info("WebSocket closed",{code:c.code,description:a,reason:c.reason||"(no reason)"}),B(null),he(),te(a),M({type:"WS_DISCONNECTED"}),ee(!1),!L&&z&&re(se.maxAttempts)&&z()}})();T=e;try{await e}finally{T===e&&(T=null)}}function me(){if(L=!0,chrome.alarms.clear($),he(),d&&d.readyState!==WebSocket.CLOSED)try{d.close(1e3,"Manual disconnect")}catch{}}async function ft(e){const{type:t}=e;if(t?.startsWith("browser-")&&t.endsWith("-result")){M({type:"BROWSER_MCP_RESULT",data:e});return}if(t!=="pong"&&t!=="health"){if(t?.startsWith("browser-")){await bt(t,e);return}M({type:"WS_MESSAGE",data:e})}}async function bt(e,t){const n=t.requestId;if(!n||typeof n!="string"){l.error("Browser request missing requestId",void 0,{type:e});return}try{switch(e){case"browser-list-tabs":{const r=await chrome.tabs.query({});u({type:"browser-list-tabs-result",requestId:n,success:!0,tabs:r.map(o=>({id:o.id,url:o.url,title:o.title,active:o.active,windowId:o.windowId,index:o.index}))});break}case"browser-navigate":{const r=t.url,o=t.tabId,i=t.newTab,c=t.active??!0;let s;if(i)s=await chrome.tabs.create({url:r,active:c});else if(o)s=await chrome.tabs.update(o,{url:r,active:c});else{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});a?.id?s=await chrome.tabs.update(a.id,{url:r}):s=await chrome.tabs.create({url:r,active:c})}u({type:"browser-navigate-result",requestId:n,success:!0,tab:{id:s.id,url:s.url,title:s.title}});break}case"browser-screenshot":{const r=t.tabId,o=t.fullPage;let i=r;if(!i){const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});i=s?.id}if(!i)throw new Error("No tab available for screenshot");const c=await chrome.tabs.captureVisibleTab({format:"png"});u({type:"browser-screenshot-result",requestId:n,success:!0,screenshot:c,fullPage:o??!1});break}case"browser-get-element-info":{await He(t);break}case"browser-click-element":{await Be(t);break}case"browser-fill-input":{await Fe(t);break}case"browser-enable-network-capture":{Je(t);break}case"browser-disable-network-capture":{Qe(t);break}case"browser-get-network-requests":{Xe(t);break}case"browser-clear-network-requests":{Ye(t);break}case"browser-enable-debugger-capture":{await rt(t);break}case"browser-disable-debugger-capture":{await ot(t);break}case"browser-get-debugger-requests":{st(t);break}case"browser-clear-debugger-requests":{ct(t);break}default:l.warn("Unhandled browser request type",{type:e}),u({type:`${e}-result`,requestId:n,success:!1,error:`Unknown request type: ${e}`})}}catch(r){l.error("Browser request failed",r instanceof Error?r:void 0,{type:e}),u({type:`${e}-result`,requestId:n,success:!1,error:r instanceof Error?r.message:String(r)})}}function gt(){if(L){l.debug("Auto-reconnect disabled (manual disconnect)");return}const e=ut(),t=e+1;if(!re(se.maxAttempts)){l.warn("Max reconnect attempts reached",{attempts:e});return}ve(t);const n=Math.min(Math.pow(2,t-1),30);l.info("Scheduling reconnect",{delaySeconds:n,attempt:t}),chrome.alarms.create($,{delayInMinutes:n/60})}lt(gt);function ht(){chrome.alarms.onAlarm.addListener(e=>{e.name===$&&(l.debug("Reconnect alarm fired"),k())})}const q=R("Background");async function mt(){q.info("Oko service worker starting"),await qe(),Me(),ht(),Se(e=>{(e.key==="backendUrl"||e.key==="authToken")&&(q.info("Connection settings changed, reconnecting"),me(),k())}),k()}chrome.runtime.onConnect.addListener(e=>{q.debug("Client connected",{name:e.name}),O.add(e),e.onDisconnect.addListener(()=>{q.debug("Client disconnected",{name:e.name}),O.delete(e)}),e.onMessage.addListener(t=>{pt(e,t)})});chrome.runtime.onMessage.addListener((e,t,n)=>{const r=e?.type;if(r==="DISCONNECT")return me(),te("Manual disconnect"),n({success:!0}),!0;if(r==="RECONNECT")return k(),n({success:!0}),!0;if(r==="GET_WS_STATUS"){const o=U();return n({connected:V(),status:o.connection.status,reconnectAttempts:o.connection.reconnectAttempts}),!0}if(r==="GET_STATE")return n(U()),!0;if(r==="ELEMENT_SELECTED"){const o=e.element;return o.tabId=t.tab?.id,V()?u({type:"element-selected",element:o}):(Ne(o),k()),n({success:!0}),!0}return!1});function pt(e,t){const n=t.type;switch(n){case"GET_CONNECTION_STATUS":e.postMessage({type:"CONNECTION_STATUS",connected:V(),state:U()});break;case"RECONNECT":k();break;default:q.debug("Unknown message type",{type:n})}}chrome.runtime.onInstalled.addListener(e=>{q.info("Extension installed/updated",{reason:e.reason})});chrome.alarms.create("keepalive",{periodInMinutes:1});chrome.alarms.onAlarm.addListener(e=>{e.name==="keepalive"&&q.debug("Keepalive ping")});mt();
